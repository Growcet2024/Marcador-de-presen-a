<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <!-- Cabe√ßalho da P√°gina -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marcador de presen√ßa</title>

<link rel="stylesheet" href="styles.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
    <!-- Carregando o Font Awesome Carrega √≠cones l√°pis-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

<!-- Gerar Mapa local PDF-->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

     <!-- Biblioteca QRCode (uma vez no projeto) -->

<!-- Biblioteca QRCode MAPA -->
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>


    <title>Marcador de presen√ßa</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <style>


body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 0;
    background-color: #02779eE6; /* cor do fundo fora do container */
    color: #333;
}


        /* Estilos do Cabe√ßalho */
header {
    text-align: left;
    padding: 5px 10px 50px 10px; /* padding-top: 5px; padding-right:10px; padding-bottom:50px; padding-left:10px */
    background-color: #02779e; /* Cor do heder barra topo*/
    color: #fdfefe; /* Cor titulo Checkin+*/
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    z-index: 1;
    box-shadow: 0 8px 8px #0000001A;

     border-bottom: 20px solid #99c2ec; /* Linha inferior para separar o cabe√ßalho */
}


header h1 {
    margin: 0;
    font-size: 20px;
}


/* CSS COR CONTEIN PRINCIPAL*/
.container {
    max-width: 600px;          /* Limita a largura m√°xima da container para 600px */
    width: calc(100% - 10px);  /* Subtrai 10px (5px √† esquerda + 5px √† direita) */
    margin-left: 5px;          /* Margem de 5px √† esquerda */
    margin-right: 5px;         /* Margem de 5px √† direita */
    padding: 10px;
    background-color: #f0f4f8;
    box-shadow: 0 4px 8px #0000001A;
    border-radius: 15px;
    position: relative;
    z-index: 2;
    display: block;
    box-sizing: border-box;
}

/* Centraliza√ß√£o */
body {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
}


/* CSS container fim */

.container h2 {
    font-size: 18px;
    color: #000000;
}

   /*Controlar a distancio no topo*/
.container {

    /* margin-top: 150px;  Remover valor fixo */
    position: relative;
    z-index: 2;
    padding: 10px;
    max-width: 600px;
    margin: auto;
    background-color: #f0f4f8;
    box-shadow: 0 4px 8px #0000001A;
    border-radius: 15px;
    margin-bottom: 20px;
}

.container {
    position: relative;
    z-index: 2;
}


/* ABINHA SUPERIOR topo*/
.container::before {
    content: "";
    position: absolute;
    top: -20px;                 /* Quanto sobe no header */
    left: 50%;
    transform: translateX(-50%);
    width: 200px;               /* Largura da meia-lua */
    height: 19px;               /* Altura */
    background:
        linear-gradient(to bottom,
            rgba(255,255,255,0.9),
            rgba(255,255,255,0.4)
        ),
        #f0f4f8;
    clip-path: ellipse(50% 100% at 50% 100%);
    box-shadow:
        0 2px 3px rgba(0,0,0,0.15),        /* Encaixe */
        0 6px 10px rgba(0,0,0,0.25),       /* Profundidade */
        inset 0 1px 1px rgba(255,255,255,0.8); /* Luz interna */
    z-index: 3;
    animation: moveAba 10s ease-in-out infinite alternate;
}

/* Anima√ß√£o para mover a aba (superior) */
@keyframes moveAba {
    0% {
        transform: translateX(-50%) translateX(-30%); /* Come√ßa na esquerda */
    }
    50% {
        transform: translateX(-50%) translateX(30%);  /* Vai para a direita */
    }
    100% {
        transform: translateX(-50%) translateX(-30%); /* Volta para a esquerda */
    }
}



/* ABINHA INFERIOR topo*/
.container::after {
    content: "";
    position: absolute;
    top: 1px;                 /* Coloca a aba inferior logo abaixo da superior */
    left: 50%;
    transform: translateX(-50%);
    width: 200px;              /* Mesma largura que a superior */
    height: 19px;              /* Mesma altura que a superior */

    clip-path: ellipse(50% 100% at 50% 0%); /* Formato espelhado */
    box-shadow:
        0 2px 3px rgba(0,0,0,0.15), 
        0 6px 10px rgba(0,0,0,0.25), 
        inset 0 1px 1px rgba(255,255,255,0.8); /* Mesma sombra da superior */

    z-index: 2; /* Aba inferior abaixo da superior */
    background-color: rgba(0, 0, 255, 0.3); /* Cor de fundo tempor√°ria para ajudar na visualiza√ß√£o */
    animation: moveAba 10s ease-in-out infinite alternate;
}

/* Anima√ß√£o para mover a aba (superior e inferior) */
@keyframes moveAba {
    0% {
        transform: translateX(-50%) translateX(-30%); /* Come√ßa na esquerda */
    }
    50% {
        transform: translateX(-50%) translateX(30%);  /* Vai para a direita */
    }
    100% {
        transform: translateX(-50%) translateX(-30%); /* Volta para a esquerda */
    }
}

/* ABINHA INFERIOR COR*/
.container::after {
   
    /* efeito material / relevo invertido */
    background:
        linear-gradient(to top,
            rgba(255,255,255,0.85),
            rgba(255,255,255,0.3)
        ),
        #f0f4f8;
    z-index: 1;
}



/* ABINHA final */
















        /* Estilos do Mapa */
        #map {
            border-radius: 8px;
        }


        /* IMPUT - √Årea de Texto (Descri√ß√£o) */
        textarea, input[type="text"] {
            width: 100%;
            padding: 10px !important;  /* afastar o texto das bordas */
            height: 40px;              /* ajuste a altura para manter o tamanho original */
            margin: 10px 0;
            border: 1px solid #ccc;
            border-radius: 10px;
            resize: none;
            font-size: 14px;
            box-sizing: border-box;
            background-color: #f0f7ff; /* üëà Fundo secund√°rio */
        }


/* =========================
   Bot√µes padronizados com efeito glossy e centralizados
   ========================= */
button {
    width: 90%;                   /* Largura menor que 100% */
    display: block;               /* Garante que margin auto funcione */
    margin: 15px auto;            /* Centraliza horizontalmente + espa√ßamento vertical */
    padding: 10px;                /* Mant√©m altura do bot√£o */
    border: 2px solid #5fa5b4;   /* Borda fina moderna */
    border-radius: 25px;          /* Arredondado */
    font-size: 16px;              /* Tamanho da fonte */
    font-weight: bold;            /* Peso da fonte */
    cursor: pointer;
    position: relative;           /* Necess√°rio para o efeito glossy */
    overflow: hidden;             /* Brilho n√£o vaza */
    color: white;                 /* Cor do texto */
    background: linear-gradient(to bottom, #02779e, #02779e); /* Gradiente base */
    transition: background 0.3s, transform 0.2s;
    box-sizing: border-box;
}


/* Brilho pl√°stico no topo */
button::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 50%;
    background: linear-gradient(to bottom, #FFFFFF66, #FFFFFF00); /* Transpar√™ncia para efeito glossy */
    border-top-left-radius: 25px;
    border-top-right-radius: 25px;
    pointer-events: none;
}

/* Hover */
button:hover {
    background: linear-gradient(to bottom, #0393bb, #02779e); /* Gradiente mais claro ao passar o mouse */
    transform: scale(1.02);
}

/* Clique */
button:active {
    transform: scale(0.98);
}

/* Hist√≥rico de bot√µes (separados por cores para identificar a√ß√£o) */
.history-buttons button:nth-child(1) {
    background: linear-gradient(to bottom, #02779e, #02779e); /* Verde WhatsApp */
}

.history-buttons button:nth-child(2) {
    background: linear-gradient(to bottom, #02779e, #02779e); /* Laranja PDF */
}

.history-buttons button:nth-child(3) {
    background: linear-gradient(to bottom, #02779e, #02779e); /* Vermelho Apagar */
}


        /* Estilos dos Campos de Coordenadas, Data/Hora e Endere√ßo */
        .field {
            margin: 10px 0;
        }

        .field h2 {
            font-size: 16px;
            color: #333;
        }

       

/* 1 - Mapa Popup transparente com efeito vidro (recomendado) Eu estou aqui */

/* Fundo da caixa da popup */
/* Caixa da popup */
.leaflet-popup-content-wrapper {
    background: #FFFFFF99 !important;
    backdrop-filter: blur(6px);
    color: #000000;
    border-radius: 6px;
    max-width: 160px;
    padding: 2px 2px; /* isso sozinho n√£o resolve */
}

/* Conte√∫do da popup */
.leaflet-popup-content {
    margin: 0;      /* remove margens extras */
    padding: 4px;   /* reduz o espa√ßo interno do texto */
    font-size: 14px;
}


/* Tri√¢ngulo apontando para o marcador */
.leaflet-popup-tip {
    background: #FFFFFF99 !important;  /* branco com 25% de opacidade */
    backdrop-filter: blur(6px);
}



<!-- CSS HISTORICO-->

#/* Estilos do Container do Hist√≥rico */
#history-container {
    padding: 10px;
    margin: 10px auto 0 auto; /* topo, auto, baixo, auto */
    max-width: 600px;
    background-color: #f0f4f8;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    border-radius: 15px;
}

/* Cada registro da lista */
.record {
    background-color: #f0f4f8;
    border: 2px solid #ddd;
    padding: 25px;
    margin-bottom: 10px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

/* Bot√µes dentro do hist√≥rico */
.history-buttons {
    display: flex;
    flex-direction: column;
    gap: 15px;
    margin-top: 10px;
}

.history-buttons button {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 90%;
    padding: 10px;
    border: none;
    border-radius: 15px;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    transition: background 0.3s, transform 0.2s;
    margin: 0 auto;
}

.history-buttons button i {
    margin-right: 8px;
    font-size: 18px;
}



/* Input do Nome (caixa de digita√ß√£o) */
#user-name {
    display: none;
    width: 100%;
    padding: 10px;
    margin: 10px auto;
    border: 1px solid #ccc;
    border-radius: 10px;
    font-size: 14px;
    background-color: #f0f7ff; /* azul bem suave */
    box-sizing: border-box;
    display: block;
}



/* Toggle switch BOOLEANO*/
.switch {
    position: relative;
    display: inline-block;
    width: 46px;
    height: 24px;
}

.switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.slider {
    position: absolute;
    cursor: pointer;
    inset: 0;
    background-color: #ccc;
    transition: .3s;
    border-radius: 24px;
}

.slider:before {
    position: absolute;
    content: "";
    height: 18px;
    width: 18px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: .3s;
    border-radius: 50%;
}

input:checked + .slider {
    background-color: #99c2ec;
}

input:checked + .slider:before {
    transform: translateX(22px);
}

.toggle-container {
    display: flex;
    align-items: center; /* alinha verticalmente */
    gap: 10px;           /* espa√ßo entre bot√£o e texto */
    margin-bottom: 20px; /* espa√ßo abaixo do toggle */
}


/* Toggle switch BOOLEANO*/


/* CSS menu */
/* √çcone do Menu Hamb√∫rguer */
.menu-hamburguer {
    font-size: 30px;
    cursor: pointer;
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 100; /* Aumentamos para ficar sobre o mapa */
    color: #f0f4f8; /* Os tr√™s tra√ßos */
    background: #ffffff00  ; /* Cor fundo 3 tracinhos menu f0f4f8 */
    border-radius: 5px;
    padding: 5px 10px;
   // box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2); //
}

/* Menu Deslizante */
.menu-lateral {
    width: 250px;
    height: 100%;
    background: linear-gradient(to right, #00000066, #00000033);  /* Cor fundo lateral direita */
    color: white;
    position: fixed;
    top: 0;
    right: -250px; /* Escondido inicialmente */
    transition: right 0.3s ease;
    z-index: 99; /* Aumentamos para ficar sobre o mapa */
    padding-top: 60px;
}

/* Estilo da Lista do Menu */
.menu-lateral ul {
    list-style: none;
    padding: 0;
}

.menu-lateral ul li {
    padding: 15px;
    border-bottom: 1px solid #444;
}

.menu-lateral ul li a {
    color: white;
    text-decoration: none;
    font-size: 18px;
    display: block;
}

.menu-lateral ul li a:hover {
    background: #444;
}

#map {
    position: relative;
    z-index: 1; /* Mant√©m o mapa abaixo do menu */





    
        <style>
    /* Estilo da bolha */
    .bubble { 
        position: absolute;
        width: 80px; /* Tamanho da bolinha (largura) */
        height: 80px; /* Tamanho da bolinha (altura) */
        border-radius: 50%; /* Para manter a bolinha redonda */
        pointer-events: none;
        z-index: 9999; /* Garantindo que a bolha fique sempre acima do mapa e do conte√∫do */

        /* Lente */
        border: 2px solid #000000BF; /* Branco com 75% de opacidade */
        box-shadow:
            inset 0 0 5px #ffffff99,   /* Branco com 60% de opacidade */
            0 0 5px #ffffff59;        /* Branco com 35% de opacidade */

        /* Zoom percept√≠vel */
        backdrop-filter: zoom(3.5);
    }

    /* Map container */
    #map {
        z-index: 1; /* Garantindo que o mapa tenha um z-index menor do que a bolha */
    }
</style>




<!-- Estilos CSS -->


    
    </style>

    <!-- seu conte√∫do HTML aqui -->


    <!-- Controlar a distancio no topo -->
<script>

window.addEventListener('load', function() {
    const header = document.querySelector('header');
    const container = document.querySelector('.container');

    const ajuste = -35; // valor negativo faz o container subir sobre o header
    container.style.marginTop = (header.offsetHeight + ajuste) + 'px';
});

</script>



<span class="menu-hamburguer">‚Ä¢‚Ä¢‚Ä¢</span>
<div class="menu-lateral">
    <ul>
        <li><a href="sobre.html">Sobre</a></li>
        <li><a href="informa√ß√µes.html">Informa√ß√µes importates</a></li>
    </ul>
</div>

<script>
const menuIcon = document.querySelector(".menu-hamburguer");
const menuLateral = document.querySelector(".menu-lateral");

let touchStartX = 0;

// Clique no √≠cone abre/fecha
menuIcon.addEventListener("click", () => {
    if (menuLateral.style.right === "0px") {
        menuLateral.style.right = "-250px";
    } else {
        menuLateral.style.right = "0px";
    }
});

// Detectar toque para arrastar
menuLateral.addEventListener("touchstart", (e) => {
    touchStartX = e.touches[0].clientX;
});

menuLateral.addEventListener("touchend", (e) => {
    let touchEndX = e.changedTouches[0].clientX;
    let diffX = touchEndX - touchStartX;

    if (diffX > 50) { // arrastou mais de 50px para a direita
        menuLateral.style.right = "-250px"; // fecha
    }
});
</script>



<script>
    /* Vari√°veis Globais */
    let currentLatitude = "-";
    let currentLongitude = "-";
    let userName = "Usu√°rio Logado";

    /* Fun√ß√µes JavaScript */



    // fUN√á√ÉO USU√ÅRIO ID
    
 // BLOCO- 1
// Fun√ß√£o para gerar um ID √∫nico com data de cria√ß√£o + parte aleat√≥ria
// Formato: YYYYMMDD-XXXXXX  (ex: 20250324-K8F9A2)

function generateRandomID() {
    const now = new Date();

    const year  = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day   = String(now.getDate()).padStart(2, '0');

    const datePart = `${year}${month}${day}`;

    const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    let randomPart = '';
    for (let i = 0; i < 6; i++) {
        randomPart += characters.charAt(
            Math.floor(Math.random() * characters.length)
        );
    }

    return `${datePart}-${randomPart}`;
}



// BLOCO-2
function checkUserName() {
    const savedUserName = localStorage.getItem("userName");
    const savedUserID = localStorage.getItem("userID");

    if (savedUserName && savedUserID) {

        // Mostra dados do usu√°rio
        document.getElementById("user-name").style.display = "none";
        document.getElementById("user-name-display").style.display = "inline";
        document.getElementById("user-name-display").innerText =
            `Usu√°rio: ${savedUserName} (ID: ${savedUserID})`;

        // Bot√µes
        document.getElementById("save-name-button").style.display = "none";
        document.getElementById("edit-name-button").style.display = "inline";

        // üîí ID N√ÉO √â EDIT√ÅVEL (garantia de seguran√ßa)
        const editIdBtn = document.getElementById("edit-id-button");
        if (editIdBtn) editIdBtn.style.display = "none";

    } else {

        // Primeiro acesso (sem nome salvo)
        document.getElementById("user-name").style.display = "inline";
        document.getElementById("save-name-button").style.display = "inline";
        document.getElementById("edit-name-button").style.display = "none";

        const editIdBtn = document.getElementById("edit-id-button");
        if (editIdBtn) editIdBtn.style.display = "none";
    }
}



// BLOCO- 3
// Fun√ß√£o para salvar o nome do usu√°rio e gerar um ID √∫nico FIXO (com data)

function saveUserName() {
    const userName = document.getElementById("user-name").value.trim();

    if (!userName) {
        alert("Por favor, digite um nome.");
        return;
    }

    // Verifica se j√° existe um ID salvo
    let userID = localStorage.getItem("userID");

    if (!userID) {
        // Gera data no formato YYYYMMDD
        const now = new Date();
        const yyyy = now.getFullYear();
        const mm = String(now.getMonth() + 1).padStart(2, "0");
        const dd = String(now.getDate()).padStart(2, "0");
        const datePart = `${yyyy}${mm}${dd}`;

        // Gera sufixo aleat√≥rio de 5 caracteres
        const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
        let suffix = "";
        for (let i = 0; i < 5; i++) {
            suffix += chars.charAt(Math.floor(Math.random() * chars.length));
        }

        userID = `${datePart}-${suffix}`;


        // üîí Salva o ID UMA √öNICA VEZ
        localStorage.setItem("userID", userID);
    }

    // Atualiza apenas o nome (ID permanece intacto)
    localStorage.setItem("userName", userName);

    // Atualiza a interface
    checkUserName();
}


// BLOCO- 4 Fun√ß√£o para permitir editar o nome do usu√°rio
function editUserName() {
    document.getElementById("user-name").style.display = "inline";
    document.getElementById("save-name-button").style.display = "inline";
    document.getElementById("user-name-display").style.display = "none";
    document.getElementById("edit-name-button").style.display = "none";
    document.getElementById("user-name").value = localStorage.getItem("userName");
}

  // fim Fun√ß√£o usu√°rio



    // Fun√ß√£o para obter o endere√ßo a partir das coordenadas
    function getAddressFromCoordinates(latitude, longitude) {
        const apiUrl = `https://us1.locationiq.com/v1/reverse?key=pk.73c7ec951f7e0c38e842f740a1a63917&lat=${latitude}&lon=${longitude}&format=json`;

        fetch(apiUrl)
            .then(response => response.json())
            .then(data => {
                const roadName = data.address.road || "N/A";
                const address = `Local: ${roadName},
                                 Bairro: ${data.address.residential || "N/A"},
                                 Regi√£o: ${data.address.suburb || "N/A"},
                                 Cidade: ${data.address.city || "N/A"},
                                 Estado: ${data.address.state || "N/A"},
                                 CEP: ${data.address.postcode ? data.address.postcode.substring(0, 5) : "N/A"},
                                 Pa√≠s: ${data.address.country || "N/A"}`;

                document.getElementById("road-name").innerText = `Local: ${roadName}`;
                document.getElementById("address").innerText = address;
            })
            .catch(error => {
                console.error("Erro ao obter endere√ßo:", error);
                document.getElementById("road-name").innerText = "Erro ao obter nome da rua.";
                document.getElementById("address").innerText = "Erro ao obter endere√ßo.";
            });
    }


// Bloco=2 = Altera√ß√£o feita: A fun√ß√£o updateMap foi modificada para usar Leaflet com OpenStreetMap
function updateMap(lat, lon) {
            // Inicializando o mapa com OpenStreetMap usando Leaflet
            const map = L.map('map').setView([lat, lon], 15); // Altera√ß√£o: agora usa o Leaflet

            // Camada de OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // Adicionando marcador no mapa
            L.marker([lat, lon]).addTo(map)
                .bindPopup('Voc√™ est√° aqui!')
                .openPopup();
        }
             // Bloco= 2 fim








// 1 ===== BLOCO BASE ‚Äî INDEXEDDB (INFRA) =====
const DB_NAME = "CheckinDB";
const DB_VERSION = 1;
const STORE_NAME = "presenceRecords";

let db = null;


// 2 ===== üîí prote√ß√£o =====

async function ensureDB() {
    if (db && db.objectStoreNames.contains(STORE_NAME)) {
        return db;
    }
    db = null;
    return await initDB();
}



function initDB() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);

        request.onupgradeneeded = (event) => {
            const database = event.target.result;


            if (!database.objectStoreNames.contains(STORE_NAME)) {
                database.createObjectStore(STORE_NAME, {
                    keyPath: "id",
                    autoIncrement: true
                });
            }
        };


        request.onsuccess = (event) => {
            db = event.target.result;
            resolve(db);
        };



    // 1 üîí prote√ß√£o para evitar DB "morto" ap√≥s erro ou reload
db.onclose = () => {
    db = null;
};

db.onerror = () => {
    db = null;
};




// ===== Notifica√ß√£o armazenamento cheio =====
        request.onerror = (event) => {
    const err = event.target.error;

    if (err && err.name === "QuotaExceededError") {
        const msg = document.getElementById("saveMessage");
        if (msg) msg.innerText = "Armazenamento cheio. Limpe os dados do site.";
        msg.style.textAlign = "center";
        msg.style.color = "red";
    }
    // Cor da mensagem üëà

    reject(err);
};
});
}




// 1 ===== BLOCO BASE ‚Äî INDEXEDDB (INFRA) =====


// Inicializa o IndexedDB ao carregar o app (necess√°rio)
document.addEventListener("DOMContentLoaded", () => {
    initDB();
});



// 3 ===== LEITURA INDEXEDDB (TESTE) =====

async function getAllRecordsFromDB() {
const database = await ensureDB();
// 3 ===== not bug=====

    return new Promise((resolve, reject) => {
        if (!db) {
            reject("DB n√£o inicializado");
            return;
        }


// 4 ===== not bug====

      const tx = database.transaction(STORE_NAME, "readonly");
        const store = tx.objectStore(STORE_NAME);
        const request = store.getAll();


        request.onsuccess = () => {
            resolve(request.result);
        };

        request.onerror = () => {
            reject(request.error);
        };
    });
}


// 3 ===== LEITURA INDEXEDDB (TESTE) =====


// 4 ===== HIST√ìRICO VIA INDEXEDDB =====
async function getHistoryRecords() {
    try {
        const records = await getAllRecordsFromDB();
        return records || [];
    } catch (e) {
        console.error("Erro ao ler hist√≥rico do IndexedDB", e);
        return [];
    }
}
// 4 ===== HIST√ìRICO VIA INDEXEDDB =====



    // Fun√ß√£o para salvar o registro üëà
    async function saveRecord() {

     // Notifica√ß√£o armazenamento cheio üëà
        const msg = document.getElementById("saveMessage");

     if (msg) msg.innerText = "";

if (msg) {
    msg.innerText = "";
    msg.style.color = "";
}
 // Notifica√ß√£o armazenamento cheio üëà

        const database = await ensureDB();
        // 5 ===== not bug=====

    const coordinates = document.getElementById("coordinates").innerText;
    const address = document.getElementById("address").innerText;
    const timestamp = document.getElementById("timestamp").innerText;


   // Agora recupera o nome e o ID do usu√°rio salvo no localStorage
const userInput = localStorage.getItem("userName") || "Usu√°rio";  
const userID = localStorage.getItem("userID") || "Sem ID";  // Recupera o ID ou usa um valor padr√£o
const description = document.getElementById("description").value || "Nenhuma descri√ß√£o fornecida.";


const record = {
    userName: userInput,
    userID: userID,  // Aqui estamos incluindo o ID no registro
    coordinates,
    address,
    description,
    timestamp,
};


// Captura do mapa atual em Base64- indeBD
const mapElement = document.getElementById("map");
const canvas = await html2canvas(mapElement, { useCORS: true, scale: 2 });
record.mapImage = canvas.toDataURL("image/png");
record.mapWidth = canvas.width;
record.mapHeight = canvas.height;
// Captura do mapa atual em Base64- indeBD



// 2 ===== SALVAR TAMB√âM NO INDEXEDDB inicio =====
       
{
const tx = database.transaction(STORE_NAME, "readwrite");
 // 6 ===== not bug===== apagar if (db) ==

    const store = tx.objectStore(STORE_NAME);
    store.add(record);
}


//  ===== SALVAR TAMB√âM NO INDEXEDDB  =====

    const saveButton = document.querySelector("button[onclick='saveRecord()']");
    saveButton.innerText = "Registro salvo com sucesso!";
    setTimeout(() => {
        saveButton.innerText = "Salvar Registro";
    }, 2000);
}











// ===== IMPORTANTE N√ÉO APAGAR ===== üëà
function parseCoords(coordString) {
    // coordString exemplo: "Latitude: -23.6766 Longitude: -46.1234"
    const match = coordString.match(/Latitude:\s*([-0-9.]+)\s*Longitude:\s*([-0-9.]+)/);
    if (!match) return null;  // Retorna null se n√£o encontrar
    return `${match[1]},${match[2]}`;  // Retorna "lat,lon"
}
// ===== IMPORTANTE N√ÉO APAGAR ===== üëà



   // Bloco= 1 inicio  Carregando mapa com atrazo projeto 42
              
   // Fun√ß√£o para carregar a localiza√ß√£o
function trackLocation() {
    // Exibe o GIF de carregamento assim que come√ßamos a buscar a localiza√ß√£o
    showLoading();

    // Esconde o mapa antes de come√ßar
    document.getElementById("map").style.display = 'none';


    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            (position) => {
                currentLatitude = position.coords.latitude;
                currentLongitude = position.coords.longitude;

                const timestamp = new Date().toLocaleString();

                document.getElementById("coordinates").innerText =
                    `Latitude: ${currentLatitude}\nLongitude: ${currentLongitude}`;
                document.getElementById("timestamp").innerText = timestamp;

                getAddressFromCoordinates(currentLatitude, currentLongitude);


                // Agora, exibe o mapa
                document.getElementById("map").style.display = 'block';

                // Inicializa o mapa com as coordenadas obtidas
                map = L.map('map').setView([currentLatitude, currentLongitude], 15);



              
                // Ajuste para o mapa abrir no firebase

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
    crossOrigin: true
}).addTo(map);


// Adiciona o marcador e a popup Mapa
            
const userName = localStorage.getItem("userName") || "Usu√°rio";

// Fun√ß√£o para converter metros em pixels baseado no zoom do mapa
function metersToPixels(meters, lat, map) {
    const pointC = map.latLngToContainerPoint([lat, 0]);
    const pointX = map.latLngToContainerPoint([lat, meters / 111320]); // 1 grau ~ 111.32 km
    return Math.abs(pointX.x - pointC.x);
}

// Obtem a posi√ß√£o do usu√°rio
navigator.geolocation.getCurrentPosition((position) => {
    const currentLatitude = position.coords.latitude;
    const currentLongitude = position.coords.longitude;
    let gpsAccuracy = position.coords.accuracy;

    // Limita o raio do c√≠rculo para n√£o ficar muito grande- tamanho
    if (gpsAccuracy > 19) gpsAccuracy = 19; // Tamanho do circulo

    // --- Pin HTML tamanho ---
    const htmlPin = L.divIcon({
        html: `<div style="
            width: 5px;
            height: 5px;
            background: #007BFF;
            border-radius: 50%;
            border: 2px solid #0056b3;
        "></div>`,
        className: '',
        iconSize: [12, 12],
        iconAnchor: [6, 6]
    });


   L.marker([currentLatitude, currentLongitude], { icon: htmlPin })
    .addTo(map)
    .bindPopup(`
        <div style="text-align: center;">
            Eu estou aqui üòä<br>
            <strong>${userName}</strong>
        </div>
    `)
    .openPopup();


    // --- C√≠rculo de precis√£o HTML ---
    function addAccuracyCircle() {
        const pixelRadius = metersToPixels(gpsAccuracy, currentLatitude, map);

        // Ajuste para centralizar o c√≠rculo e evitar deslocamento
        const htmlCircle = L.divIcon({
            html: `<div style="
                width: ${pixelRadius*3.4}px;
                height: ${pixelRadius*3.4}px;
                background: #007BFF2E;
                border: 1px solid #007BFF;
                border-radius: 50%;

                transform: translate(-${pixelRadius}px, -${pixelRadius}px);

                position: absolute;
            "></div>`,
            className: '',
            iconSize: [pixelRadius*2, pixelRadius*2],
            iconAnchor: [pixelRadius, pixelRadius]
        });

        // Remove c√≠rculo antigo se houver
        if (window.accuracyMarker) map.removeLayer(window.accuracyMarker);

        window.accuracyMarker = L.marker([currentLatitude, currentLongitude], { icon: htmlCircle }).addTo(map);
    }

    // Inicializa o c√≠rculo
    addAccuracyCircle();

    // Atualiza o c√≠rculo ao mudar o zoom
    map.on('zoomend', addAccuracyCircle);

    // Centraliza o mapa na posi√ß√£o do usu√°rio
    map.setView([currentLatitude, currentLongitude], 16);
});


                // Corrige o redimensionamento do mapa ap√≥s a exibi√ß√£o
                map.invalidateSize();

                // Esconde o GIF de carregamento ap√≥s o mapa ser exibido
                hideLoading();
            },
            (error) => {
                console.error("Erro ao obter localiza√ß√£o:", error);
                document.getElementById("coordinates").innerText = "Erro ao obter localiza√ß√£o.";
                playSound("error-sound.mp3");

                // Esconde o GIF de carregamento em caso de erro
                hideLoading();
            }
        );
    } else {
        alert("Geolocaliza√ß√£o n√£o √© suportada neste navegador.");
        hideLoading(); // Garante que o GIF seja escondido em caso de erro
    }
}


// Fun√ß√£o para exibir o GIF de carregamento
function showLoading() {
    document.getElementById("loadingImage").style.display = 'block';
}

// Fun√ß√£o para esconder o GIF de carregamento
function hideLoading() {
    document.getElementById("loadingImage").style.display = 'none';
}

// Chama a fun√ß√£o trackLocation quando a p√°gina for carregada
window.onload = function () {
    trackLocation();
};


// Fun√ß√£o para exibir o GIF de carregamento
function showLoading() {
    document.getElementById("loadingImage").style.display = 'block'; // Exibe o GIF de carregamento
}

// Fun√ß√£o para esconder o GIF de carregamento
function hideLoading() {
    document.getElementById("loadingImage").style.display = 'none'; // Esconde o GIF de carregamento
}

// Chama a fun√ß√£o trackLocation quando a p√°gina for carregada
window.onload = function () {
    trackLocation();
};


// For√ßa atualiza√ß√£o do GPS ao carregar a p√°gina
window.addEventListener('load', () => {
    if (navigator.geolocation) {
        const watchID = navigator.geolocation.watchPosition(
            (position) => {
                console.log("GPS atualizado:");
                console.log("Latitude:", position.coords.latitude);
                console.log("Longitude:", position.coords.longitude);

                // Para de assistir ap√≥s a primeira atualiza√ß√£o
                navigator.geolocation.clearWatch(watchID);
            },
            (error) => {
                console.error("Erro ao atualizar GPS:", error);
            },
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            }
        );
    } else {
        console.error("Geolocaliza√ß√£o n√£o √© suportada neste navegador.");
    }
});


// Fun√ß√£o para verificar se a localiza√ß√£o est√° ativa
function verificarLocalizacaoAtiva() {
    if (navigator.geolocation) {
        const watchID = navigator.geolocation.watchPosition(
            (position) => {
                console.log("Localiza√ß√£o ativa");
                document.getElementById("alerta-gps").style.display = "none"; // Esconde o alerta
                navigator.geolocation.clearWatch(watchID); // Para de assistir
            },
            (error) => {
                if (error.code === error.PERMISSION_DENIED || error.code === error.POSITION_UNAVAILABLE) {
                    console.warn("Localiza√ß√£o desativada ou indispon√≠vel.");
                    document.getElementById("alerta-gps").style.display = "block"; // Mostra o alerta
                }
            },
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            }
        );
    } else {
        console.error("Geolocaliza√ß√£o n√£o √© suportada neste navegador.");
    }
}

// Chama a fun√ß√£o ao carregar a p√°gina
window.addEventListener('load', verificarLocalizacaoAtiva);

 // Bloco= 1 fim
// Bloco mapa na tela fim



    // Fun√ß√£o para tocar um som
    function playSound(soundFile) {
        const audio = new Audio(soundFile);
        audio.play();
    }

    // Chamada da fun√ß√£o trackLocation ao carregar a p√°gina
    window.onload = function () {
        checkUserName();  // Verificar e carregar o nome do usu√°rio salvo
        trackLocation();   // Rastrear a localiza√ß√£o do usu√°rio
    };

</script>
</head>
<body>




    <!-- Cabe√ßalho Tela principal-->
    <header>

  <h1 style="text-align: left; font-size: 22px; margin-top: 20px; margin-bottom: 10px;">
    Checkin+
  </h1>

    </header>

    <!-- Inicio conteiner=1 principal -->
    <!-- Container Principal -->
    <div class="container">
 

        <!-- Div da bolha dentro do container -->
    <div class="bubble"></div>


        <h2 style="width: 90%; margin: 15px auto; text-align: left; font-size: 15px; color: #000;">
        Marcador de presen√ßa üìç
        </h2>

        <!-- Nome da Rua -->
        <h2 id="road-name" style="width: 90%; margin: 10px auto; text-align: left; font-size: 15px; color: #000;">
        Rua: Local Carregando!
        </h2>

        <!-- Boco Mapa tipo iFrame -->
          <!-- Exibindo o GIF de carregamento antes de carregar o mapa -->
 <div id="loadingImage" style="text-align: center;">
    <img src="https://media.giphy.com/media/3oEjI6SIIHBdRxXI40/giphy.gif" alt="Carregando..." style="width: 100px; height: 100px;">
</div>

    <!-- Local do mapa OpenStreetMap -->
        <div id="map" style="width: 100%; height: 300px;"></div>


    <!-- Borda em volta conteudo -->
           <div class="info-container" style="border: 1px solid #ccc; padding: 15px; border-radius: 8px; margin-top: 20px; margin-bottom: 20px;">

    <!-- Atualizar p√°gina -->
    <a href="index.html" class="btn-voltar">Atualizar mapa üîÑ</a>

     <!-- Alerta ativar localiza√ß√£o -->
    <div id="alerta-gps" style="display: none; background-color: #ffffff; color: #000; padding: 10px; text-align: center; font-weight: bold;">
        ‚ö†Ô∏è Ative a localiza√ß√£o
    </div>

    <!-- Coordenadas -->
    <div class="field">
        <h2>Coordenadas</h2>
        <p id="coordinates">Latitude: -, Longitude: -</p>
    </div>

    <!-- Data e Hora -->
    <div class="field">
        <h2>Data e Hora</h2>
        <p id="timestamp">Local</p>
    </div>

    <!-- Endere√ßo -->
   <div class="field" style="margin-bottom: 0;">
    <h2>Endere√ßo</h2>
   <p id="address" style="margin-bottom: 0;">Local</p>
     </div>
</div>


  <!-- Movendo o campo de descri√ß√£o e o bot√£o "Salvar Registro" acima do bot√£o Compartilhar -->
        <div class="description-container">
            <textarea id="description" placeholder="Adicione uma descri√ß√£o (opcional)"></textarea>
            <button class="button" onclick="saveRecord()">Salvar Registro</button>
        </div>
        
        <!--Notifica√ß√£o armazenamento cheio-->
        <div id="saveMessage" style="margin-top:8px; font-size:14px;"></div>


        <!-- Declara√ß√£o de comparecimento na tela -->

    <p class="copyright" style="width: 91%; margin: 10px auto; text-align: left; font-size: 14px; color: #000;">
  J√° precisou provar ao chefe que foi ao m√©dico?<br>
  Precisa provar sua presen√ßa e perman√™ncia em um local?<br>
  Vai precisar provar aos pais que est√° na escola?<br>

<hr style="width: 75%; margin: 10px auto; border: 1px solid #ccc;">

<p class="copyright" style="width: 91%; margin: 10px auto; text-align: left; font-size: 14px; color: #000;">
  Com o <strong>Checkin+</strong>, voc√™ registra sua presen√ßa com apenas um clique.  
  O app gera um comprovante de chegada e sa√≠da, e uma declara√ß√£o de comparecimento com nome, ID, data, hora e localiza√ß√£o ‚Äî uma prova incontest√°vel, em texto ou PDF, pronta para enviar, baixar ou imprimir.
</p>


        <!-- Chegada / Saida -->
        <button class="button" onclick="openArrivalDeparture()">Chegada / Sa√≠da</button>

        <!-- Bot√£o para Exibir o Hist√≥rico dentro do mesmo container -->
        <button class="button" onclick="toggleHistory()">Hist√≥rico de Presen√ßa</button>



<!-- PARTE DO HIST√ìRICO -->
<!-- Inicio conteine=2 hist√≥rico -->
<!-- Container para Exibir o Hist√≥rico de Presen√ßa -->
<div id="history-container" style="display: none;">
    <h3><center>Meu hist√≥rico</h3>
    <div id="records-list" style="background-color: #ffffff; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); overflow-y: auto; padding: 10px;">
        <!-- Lista de registros ser√° carregada aqui -->
    </div>
</div>
<!-- Fim conteine=2 hist√≥rico -->



<!-- BLOCO Input NOME USU√ÅRIO -->
<div style="padding: 10px; max-width: 600px; margin: auto; margin-top: 20px;">

    <!-- Input do Nome (usado s√≥ quando N√ÉO existe nome salvo ou ao editar) -->
    <input type="text" id="user-name" placeholder="Digite seu nome">

    <!-- Nome exibido + √≠cone editar -->
    <div style="display: flex; align-items: center; justify-content: space-between; width: 95%; margin: 10px auto 0;">

        <!-- Nome + ID exibidos -->
        <span id="user-name-display" style="font-weight: bold; display: none;"></span>

        <!-- √çcone editar nome -->
        <i id="edit-name-button"
           onclick="editUserName()"
           class="fas fa-pencil-alt"
           style="font-size: 18px; color: #02779e; cursor: pointer; display: none;">
        </i>

    </div>

    <!-- Bot√£o Salvar Nome -->
    <button id="save-name-button"
            onclick="saveUserName()"
            class="button"
            style="width: 95%; padding: 10px; margin: 10px; border-radius: 15px; background-color: #28a749;">
        Salvar
    </button>

</div>
      <!-- Fim conte√∫do conteiner principal -->




      <!-- In√≠cio conte√∫do conteiner hist√≥rico -->
<script>
    <!-- Inicio conte√∫do hist√≥rico -->
    // Fun√ß√£o para alternar a visibilidade do hist√≥rico


    //IndexBD 
            async function toggleHistory() {
    const historyContainer = document.getElementById("history-container");
    const records = await getHistoryRecords();


            if (historyContainer.style.display === "none") {
                historyContainer.style.display = "block";
                const recordsList = document.getElementById("records-list");
                recordsList.innerHTML = ""; // Limpar a lista antes de adicionar novamente


// Ordenar os registros de forma decrescente (mais recente primeiro)
records.reverse();  // Aqui √© onde voc√™ inverte a ordem dos registros


// Adicionar os registros parte ver na tela do app
records.forEach((record, index) => {


// Contagem de registros
const numeroRegistro = records.length - index;



                    const recordDiv = document.createElement("div");
                    recordDiv.classList.add("record");
                    recordDiv.innerHTML = `

                    <p><strong>Registro da localiza√ß√£o n¬∫ ${numeroRegistro}</strong></p>


<div><strong>Usu√°rio:</strong> ${record.userName}</div>
<div><strong>ID:</strong> ${record.userID}</div>
<div><strong>Data/Hora:</strong> ${record.timestamp}</div>                        
<div><strong>Descri√ß√£o:</strong> ${record.description}</div>
<br> <!-- Pula uma linha depois da data -->

<div><strong>Coordenadas:</strong> <span class="coords">${record.coordinates}</span></div>

<div><strong>Endere√ßo:</strong> ${record.address}</div>

<br> <!-- Pula uma linha depois da data -->
    <!-- Aqui est√° o booleano vis√≠vel -->

   <div class="toggle-container">
    <label class="switch">
        <input type="checkbox" class="toggle-btn" onchange="toggleButtonsVisibility(${index})">
        <span class="slider"></span>
    </label>
   <span><strong>Mostrar a√ß√µes</strong></span>

</div>


<div class="history-buttons">
                  
<!-- Bot√µes hist√≥rico -->
<div class="history-buttons">


    <!-- Enviar texto WhatsApp -->
    <button class="share-btn" onclick="shareLocationHistory(${index})">
        Enviar texto WhatsApp
    </button>

    <!-- Mapa PDF -->
    <button class="button" onclick="generateMapPDFHistory(${index})">
        Mapa - Enviar / baixar
    </button>

    <!-- Declara√ß√£o PDF -->
    <button class="pdf-btn" onclick="generatePDFHistory(${index})">
        Declara√ß√£o - Enviar / baixar
    </button>

 <!-- Altera√ß√£o: Bot√£o para abrir o local no Google Maps -->
   <button class="button" onclick="openGoogleMaps('${parseCoords(record.coordinates)}')">Google Maps</button>

    <!-- Delete -->
<button class="delete-btn" onclick="deleteRecord(${index})">
        Apagar
    </button>


</div>

                       
                    `;
                    recordsList.appendChild(recordDiv);
                    recordDiv.querySelector(".history-buttons").style.display = "none";

                });
            } else {
                historyContainer.style.display = "none";
            }
        }
    



// 6 ===== DELETE REGISTRO NO INDEXEDDB COM CONFIRMA√á√ÉO =====
window.deleteRecord = async function(index) {
    const confirmar = confirm("Tem certeza que deseja apagar este registro?");
    if (!confirmar) return;

    try {
        // Recupera todos os registros
        const records = await getAllRecordsFromDB();

        if (!records || records.length === 0) return;

        // Corrige a invers√£o entre lista exibida e array real
        const originalIndex = records.length - 1 - index;
        const recordToDelete = records[originalIndex];

        if (!recordToDelete) return;

        // Abre transa√ß√£o de escrita
        const tx = db.transaction(STORE_NAME, "readwrite");
        const store = tx.objectStore(STORE_NAME);

        // Deleta pelo id
        store.delete(recordToDelete.id);

        // Recarrega a p√°gina ap√≥s deletar
        tx.oncomplete = () => {
            location.reload();
        };
    } catch (e) {
        console.error("Erro ao deletar registro do IndexedDB", e);
    }
};
// 6 ===== DELETE REGISTRO NO INDEXEDDB COM CONFIRMA√á√ÉO =====



     // Bloco= 3 = novo bloco
   
   // Fun√ß√£o para abrir a coordenada do registro no Google Maps
function openGoogleMaps(coords) {
    // coords deve estar no formato "latitude,longitude"
    const url = `https://www.google.com/maps?q=${coords}`;
    window.open(url, "_blank");
}

     // Bloco= 3 = fim novo bloco


   // FUN√á√ÉO Boolean 
function toggleButtonsVisibility(index) {
    const records = document.querySelectorAll(".record");
    const buttons = records[index].querySelector(".history-buttons");

    const checkbox = records[index].querySelector(".toggle-btn");

    if (checkbox.checked) {
        buttons.style.display = "block";
    } else {
        buttons.style.display = "none";
    }
}

   // FUN√á√ÉO Boolean 




// =========================
// FUN√á√ÉO COMPARTILHER TEXTO NO WHATSAPP
// =========================
     
// Fun√ß√£o para compartilhar no WhatsApp Texto a partir do hist√≥rico
    async function shareLocationHistory(index) {
    const records = await getAllRecordsFromDB() || [];


    // Ordenar os registros de forma decrescente (mais recente primeiro)
    records.reverse();

    const record = records[index];  // Pega o registro com o √≠ndice passado


    // üîΩ COLE EXATAMENTE AQUI
  const coordsLimpa = record.coordinates
    .match(/-?\d+(\.\d+)?/g)
    .join(",");
   

    // Obten√ß√£o do nome e ID fixos
    const userName = localStorage.getItem("userName") || "Usu√°rio";  // Nome fixo
    const userID = localStorage.getItem("userID");  // ID fixo


 // conferir se pode apagar
console.log("Timestamp salvo no registro:", record.timestamp);


// Descri√ß√£o frase no zap

const title = "Checkin+";
const additionalMessage = ""; 
const message = `*${title}*
Registro da localiza√ß√£o: 

Eu estou aqui,
Usu√°rio: ${userName} (ID: ${userID})

Data/hora local: ${record.timestamp}
Descri√ß√£o: ${record.description}

${record.coordinates}
${record.address}

Google Mapas
https://maps.google.com/?q=${coordsLimpa}
A precis√£o da localiza√ß√£o no Google Maps pode variar em um raio de 50 metros.

Aplicativo dispon√≠vel no Google Play`;

// FUN√á√ÉO 

    const whatsappUrl = `https://api.whatsapp.com/send?text=${encodeURIComponent(message)}`;
    window.open(whatsappUrl, '_blank');
}

// FUN√á√ÉO - Declara√ß√£o TEXTO Wwhatsapp Checkin+ HISTORICO- fim



// =========================
// FUNDO GERAR PDF 1
// =========================

// Fun√ß√£o DECLARA√á√ÉO PDF a partir do hist√≥rico (2¬™ parte) inicio

async function generatePDFHistory(index) {

    const records = await getAllRecordsFromDB() || [];

    // Ordenar os registros de forma decrescente (mais recente primeiro)
    records.reverse();

    const record = records[index];


// üîΩ COLE EXATAMENTE AQUI
// Extrair somente n√∫meros das coordenadas
const coordsLimpa = record.coordinates
  .match(/-?\d+(\.\d+)?/g)
  .join(",");


    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();


// =========================
// FUNDO PDF 1 PUBLIC if
// =========================
if (typeof window !== "undefined" && location.protocol !== "file:") {
  doc.addImage(
    "fundo-pdf.png",
    "png",
    0,
    0,
    doc.internal.pageSize.width,
    doc.internal.pageSize.height
  );
}
// =========================
// FUNDO PDF 1 PUBLIC if
// =========================


// =========================
// LOGO NO PDF 1 PUBLIC if
// =========================
if (typeof window !== "undefined" && location.protocol !== "file:") {
  doc.addImage(
    "logo-pdf.png",
    "PNG",
    177,
    15,
    22,
    22
  );
}
// =========================
// LOGO NO PDF 1 PUBLIC if


// =========================
// GERAR QR CODE BASE64 (AJUSTADO)
// =========================
const qrCanvas = document.createElement("canvas");

await QRCode.toCanvas(
  qrCanvas,
  `https://maps.google.com/?q=${coordsLimpa}`,
  { width: 300 } // tamanho do QR Code
);

const qrBase64 = qrCanvas.toDataURL("image/png");

// Adicionar QR Code ao PDF 1
doc.addImage(qrBase64, "PNG", 175, 90, 25, 25);

// =========================
// GERAR QR CODE BASE64 (AJUSTADO)
// =========================


// =========================
// MARCA D'√ÅGUA (segura) DECLARA√á√ÉO
// =========================
doc.saveGraphicsState();
doc.setGState(doc.GState({ opacity: 0.15 })); // transpar√™ncia
doc.setFont("helvetica", "bold");
doc.setFontSize(20);
doc.setTextColor("#02779e"); // cinza claro
doc.text(
    "Declara√ß√£o de\nComparecimento",
    90, 200,               // X e Y, ajuste conforme necessidade visual
    { align: "left", angle: 45 }
);
doc.restoreGraphicsState();
// =========================
// MARCA D'√ÅGUA (segura) DECLARA√á√ÉO
// =========================


    // Definir as margens
    const margin = 10;  // 20mm = 2cm
    const textX = margin + 0;  // Afastamento de 5mm da margem esquerda
    const pageWidth = doc.internal.pageSize.width;
    const pageHeight = doc.internal.pageSize.height;

    // Ajustando a √°rea √∫til do documento (sem contar as margens)
    const contentWidth = pageWidth - 2 * margin;
    const contentHeight = pageHeight - 2 * margin;

    // Desenhando a margem (borda de 2cm ao redor)
 

    // Obten√ß√£o do nome e ID fixos
    const userName = localStorage.getItem("userName") || "Usu√°rio";  // Nome fixo
    const userID = localStorage.getItem("userID");  // ID fixo


// FUN√á√ÉO - Declara√ß√£o PDF Checkin+ HISTORICO- 
const title = "Checkin+";
const additionalMessage = " ";
const message = `Declara√ß√£o de comparecimento: 

Eu estou aqui,
Usu√°rio: ${userName} (ID: ${userID})

Data/hora local: ${record.timestamp}
Descri√ß√£o: ${record.description}

${record.coordinates}
${record.address}

Link e QR Code da localiza√ß√£o:
https://maps.google.com/?q=${coordsLimpa}

A precis√£o da localiza√ß√£o no Google Maps pode variar em um raio de 50 metros

Aplicativo dispon√≠vel no Google Play`;


// FUN√á√ÉO - Declara√ß√£o PDF Checkin+ HISTORICO- fim

    // T√≠tulo do PDF
    doc.setFont("helvetica", "bold");
    doc.setFontSize(16);
    doc.text(title, textX, margin + 10);  // Afastamento de 5mm da margem esquerda

    // Corpo do texto (mensagem principal)
    doc.setFont("helvetica", "normal");
    doc.setFontSize(12);


doc.text(message, textX, margin + 15, { maxWidth: contentWidth - 10 });



  // Mensagem adicional (em menor tamanho)
// Calculando a posi√ß√£o vertical do link
const linkYPosition = margin + 103;  // Aqui √© onde o link do Google Maps est√° sendo colocado

// Mensagem adicional (em menor tamanho)
doc.setFontSize(12);  // Tamanho pequeno para a frase
doc.setFont("helvetica", "normal");  // Fonte normal

// Ajuste da posi√ß√£o Y para a frase ficar abaixo do link
const additionalMessageY = linkYPosition + 8.5;  // Adicionando 10mm de espa√ßamento entre o link e a frase: Aprecis√£o da localiza√ß√£o....

doc.text(additionalMessage, textX, additionalMessageY, { maxWidth: contentWidth });


    // Salvar o PDF gerado
doc.save(
  userName + "_Checkin+_Declara√ß√£o_" +
  String(new Date().getDate()).padStart(2, "0") + "-" +
  String(new Date().getMonth() + 1).padStart(2, "0") + "-" +
  new Date().getFullYear() + "_" +
  String(new Date().getHours()).padStart(2, "0") + "-" +
  String(new Date().getMinutes()).padStart(2, "0") + "-" +
  String(new Date().getSeconds()).padStart(2, "0") +
  ".pdf"
);

}

// Fun√ß√£o para gerar PDF a partir do hist√≥rico (2¬™ parte) fim 



// =========================
// FUNDO GERAR PDF 2 MAPA
// =========================

// MAPA - Fun√ß√£o COMPLETA para gerar o PDF do mapa + declara√ß√£o (HIST√ìRICO)
async function generateMapPDFHistory(index) {
    const { jsPDF } = window.jspdf;


    // Recuperar L√™ os registros salvos
const records = await getAllRecordsFromDB() || [];


    // Corrigir √≠ndice por causa do reverse()
    const originalIndex = records.length - 1 - index;
    const record = records[originalIndex];



// üîΩ COLE EXATAMENTE AQUI
// Extrair somente n√∫meros das coordenadas
const coordsLimpa = record.coordinates
  .match(/-?\d+(\.\d+)?/g)
  .join(",");



    if (!record) {
        alert("Registro n√£o encontrado.");
        return;
    }


    // Captura o mapa indexBD
    // Usa a imagem do mapa salva no registro
if (!record.mapImage) {
    alert("Imagem do mapa n√£o encontrada no registro.");
    return;
}

const imgData = record.mapImage;
    // Captura o mapa indexBD


    // Criar PDF
    const pdf = new jsPDF("p", "mm", "a4");



// =========================
// FUNDO DA P√ÅGINA MAPA PUBLIC if
// =========================
if (typeof window !== "undefined" && location.protocol !== "file:") {
  pdf.addImage(
    "fundo-pdf.png",
    "png",
    0,
    0,
    pdf.internal.pageSize.width,
    pdf.internal.pageSize.height
  );
}
// FUNDO DA P√ÅGINA MAPA



 const pageWidth = pdf.internal.pageSize.getWidth();
 const pageHeight = pdf.internal.pageSize.getHeight();

    // Captura o mapa indexBD
   const margin = 10;
const mapLeftMargin = 12;

const imgWidth  = 186; // Largura
const imgHeight = 130; // Altura
let y = 12;   // margem do topo


    // Captura o mapa indexBD


    // Adiciona o mapa
    pdf.addImage(imgData, "PNG", mapLeftMargin, y, imgWidth, imgHeight);
    y += imgHeight + 8;



// =========================
// LOGO DA P√ÅGINA MAPA PUBLIC (condicional)
// =========================
if (typeof window !== "undefined" && location.protocol !== "file:") {
  pdf.addImage(
    "logo-pdf.png", // imagem na pasta public
    "PNG",          // tipo correto
    177,            // X (ajuste - X move para esquerda e direita)
    15,            // Y (ajuste - y vertical sobe - desse)
    22,             // largura
    22              // altura
  );
}

// =========================
// LOGO NO PDF 3 (MAPA) ‚Äì PUBLIC if



    // DADOS DO REGISTRO (HIST√ìRICO)
    const userName = record.userName || "Usu√°rio";
    const userID = record.userID || "Sem ID";
    const timestamp = record.timestamp;
    const description = record.description || "Nenhuma observa√ß√£o registrada.";
    const coordinates = record.coordinates;
    const addressElement = record.address;

    // T√çTULO
    pdf.setFont("helvetica", "bold");
    pdf.setFontSize(14);
    pdf.text("Checkin+", margin + 5, y);
    y += 1;

    // SUBT√çTULOS
    pdf.setFont("helvetica", "normal");
    pdf.setFontSize(12);
   
    y += 4;

    pdf.text("Registro da localiza√ß√£o", margin + 5, y);
    y += 8;

    // TEXTO
    pdf.setFontSize(12);

    const text =
`Eu estou aqui,
Usu√°rio: ${userName} (ID: ${userID})

Data/Hora: ${timestamp}
Descri√ß√£o: ${description}

${coordinates}
${addressElement}

Link e QR Code da localiza√ß√£o:
https://maps.google.com/?q=${coordsLimpa}
A precis√£o da localiza√ß√£o pode variar em um raio de at√© 50 metros.

Aplicativo dispon√≠vel no Google Play`;

pdf.text(text, margin + 5, y, { maxWidth: pageWidth - 2 * margin - 5 });

   
   // =========================
// QR CODE MAPA (PADR√ÉO 1¬∫ PDF)
// =========================
// BLOCO 1 ‚Äî GERAR QR CODE (FUNCIONAL)
const qrCanvas = document.createElement("canvas");


await QRCode.toCanvas(
    qrCanvas,
    `https://maps.google.com/?q=${coordsLimpa}`,
    { width: 300 }
);


const qrBase64 = qrCanvas.toDataURL("image/png");

// Adicionar QR Code ao PDF Mapa
pdf.addImage(qrBase64, "PNG", 175, 237, 25, 25);
// =========================
// QR CODE MAPA (PADR√ÉO 1¬∫ PDF)
// =========================
   
    // Borda da p√°gina
    
// =========================
// MARCA D'√ÅGUA (segura) // MAPA- Historico
// =========================
pdf.saveGraphicsState();

pdf.setFont("helvetica", "bold");
pdf.setFontSize(20);
pdf.setTextColor("#c9e0e8"); // cinza claro
pdf.text(
    "Registro da\nlocoliza√ß√£o",
    100, 220,               // X e Y, ajuste conforme necessidade visual
    { align: "left", angle: 45 }
);
pdf.restoreGraphicsState();


    // Salvar PDF
    pdf.save(`Checkin+_Mapa_${timestamp}.pdf`);
}

// MAPA- Fun√ß√£o COMPLETA para gerar o PDF do mapa > fim










// =========================
// FUNDO GERAR PDF 3 CHEGADA E SAIDA
// =========================
<!-- Fun√ß√£o chegada e sa√≠da in√≠cio -->

  </script>
  <!-- Modal -->

<div id="arrival-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; 
    background:rgba(0,0,0,0.6); z-index:999; overflow:auto; padding:40px 10px; box-sizing:border-box;">


<div style="background:#f0f4f8; padding:20px; width:100%; max-width:400px; 

    min-height:75vh; /* ajusta altura do pop-up */
 margin:50px auto; /* mesma dist√¢ncia do topo e da parte inferior */
    border-radius:8px; box-shadow:0 0 10px rgba(0,0,0,0.3); box-sizing:border-box;">


    <h3>Chegada / Sa√≠da</h3>
    Selecione dois registros
    <div id="arrival-list" style="max-height:calc(75vh - 120px); overflow-y:auto; margin-bottom:15px; border:1px solid #ccc; border-radius:4px;"></div>
    
    <div style="display:flex; justify-content:space-between;">
      <button id="generate-pdf-btn" style="display:none;" onclick="generateArrivalDeparturePDF()">Gerar PDF</button>
      <button onclick="closeArrivalDeparture()">Fechar</button>
    </div>
  </div>
</div>

<!-- Modal -->
<script>

let selected = [];
let reversedRecords = [];

/* ===============================
   ABRIR CHEGADA / SA√çDA
================================ */


<!-- indeBD-->
async function openArrivalDeparture() {
const records = await getAllRecordsFromDB() || [];


    if (records.length < 2) {
        alert("√â necess√°rio pelo menos 2 registros.");
        return;
    }

    reversedRecords = [...records].reverse();
    selected = [];

    const list = document.getElementById("arrival-list");
    list.innerHTML = "";

    document.getElementById("generate-pdf-btn").style.display = "none";


    reversedRecords.forEach((record, index) => {
        const div = document.createElement("div");
        div.innerText = `${record.timestamp} - ${record.description}`;
        div.style.cursor = "pointer";
        div.style.padding = "6px";
        div.style.borderBottom = "1px solid #ccc";

     // Linha √∫nica
        div.style.whiteSpace = "nowrap";
div.style.overflow = "hidden";
div.style.textOverflow = "ellipsis";


        // Clique para selecionar/desmarcar
        div.onclick = () => {
            if (selected.includes(index)) {
                selected = selected.filter(i => i !== index);
                div.style.background = "";
            } else {
                if (selected.length >= 2) return;
                selected.push(index);
                div.style.background = "#d1f7d6";
            }

            document.getElementById("generate-pdf-btn").style.display = (selected.length === 2) ? "inline-block" : "none";
        };

        list.appendChild(div);
    });

    // Mostra o overlay
    document.getElementById("arrival-overlay").style.display = "block";

    document.body.style.overflow = "hidden";
}



/* ===============================
   FECHAR
================================ */
function closeArrivalDeparture() {
    document.getElementById("arrival-overlay").style.display = "none";

    document.body.style.overflow = "";
}



/* ===============================
   UTILIDADES
================================ */


function parseDateBR(dateStr) {
    if (!dateStr) return null;

    // Extrai n√∫meros: dia, m√™s, ano, hora, minuto, segundo
    const parts = dateStr.match(/\d+/g);

    if (!parts || parts.length < 3) return null;

    const [d, m, y, h = 0, min = 0, s = 0] = parts.map(Number);

    return new Date(y, m - 1, d, h, min, s);
}


function formatCoordinates(coords) {
    const matches = coords?.match(/-?\d+\.?\d*/g);
    return matches && matches.length >= 2 ? `${matches[0]},${matches[1]}` : "";
}


/* ===============================
   GERAR PDF
================================ */


async function generateArrivalDeparturePDF() {



    if (selected.length !== 2) {
        alert("Selecione dois registros.");
        return;
    }

    const rec1 = reversedRecords[selected[0]];
    const rec2 = reversedRecords[selected[1]];

    const chegada = parseDateBR(rec1.timestamp) < parseDateBR(rec2.timestamp) ? rec1 : rec2;
    const saida   = chegada === rec1 ? rec2 : rec1;

    const start = parseDateBR(chegada.timestamp);
    const end   = parseDateBR(saida.timestamp);
    const diff  = end - start;

    // Calcula dias, horas e minutos
    const minutos = Math.floor(diff / 60000) % 60;
    const horas   = Math.floor(diff / 3600000) % 24;
    const dias    = Math.floor(diff / 86400000);

    // =========================
    // MONTA TEMPO TOTAL DE PERMAN√äNCIA
    // Mostra apenas unidades existentes, evitando 0 dias ou 0 horas
    // =========================

    let tempoParts = [];
    if (dias > 0) tempoParts.push(`${dias} ${dias === 1 ? "dia" : "dias"}`);
    if (horas > 0) tempoParts.push(`${horas} ${horas === 1 ? "hora" : "horas"}`);
    tempoParts.push(`${minutos} ${minutos === 1 ? "minuto" : "minutos"}`); // sempre mostra minutos
    const tempo = tempoParts.join(", ");

    // Formata coordenadas com fallback caso estejam vazias
    const chegadaCoords = formatCoordinates(chegada.coordinates) || "0,0";
    const saidaCoords   = formatCoordinates(saida.coordinates) || "0,0";


const { jsPDF } = window.jspdf;
const doc = new jsPDF();



// =========================
// FUNDO PDF 1 CHEGADA E SA√çDA PUBLIC if
// =========================
if (typeof window !== "undefined" && location.protocol !== "file:") {
  doc.addImage(
    "fundo-pdf.png",
    "png",
    0,
    0,
    doc.internal.pageSize.width,
    doc.internal.pageSize.height
  );
}
// =========================
// FUNDO PDF 1 CHEGADA E SA√çDA PUBLIC if
// =========================

// =========================
// LOGO NO PDF 1 PUBLIC if
// =========================
if (typeof window !== "undefined" && location.protocol !== "file:") {
  doc.addImage(
    "logo-pdf.png",
    "PNG",
    177,
    15,
    22,
    22
  );
}
// =========================
// LOGO NO PDF 1 PUBLIC if
// =========================


// =========================
// T√≠tulo e subt√≠tulo
// =========================
doc.setFont("helvetica", "bold");
doc.setFontSize(16);
doc.text("Checkin+", 10, 20);

doc.setFont("helvetica", "normal");
doc.setFontSize(12);
doc.text("Comprovante de chegada e sa√≠da", 10, 25);



// =========================
// Conte√∫do antes de CHEGADA- 1
// =========================
const textoAntesChegada = `
Usu√°rio: ${chegada.userName}
ID: ${chegada.userID}
`;

// Escreve o conte√∫do antes de CHEGADA
doc.setFont("helvetica", "normal");
doc.setFontSize(12);
doc.text(textoAntesChegada, 10, 30);

// =========================
// CHEGADA com bolinha verde
// =========================
let y = 22 + textoAntesChegada.split('\n').length * 7; // calcula Y logo ap√≥s o texto anterior
doc.setFillColor(0, 200, 0); // verde
doc.circle(11, y - 2, 1.5, 'F'); // bolinha preenchida
doc.text(" CHEGADA", 13, y); // texto logo ap√≥s a bolinha


// =========================
// Conte√∫do entre CHEGADA e SA√çDA
// =========================
const textoEntre = `
Data/Hora: ${chegada.timestamp}
Descri√ß√£o: ${chegada.description}

${chegada.coordinates || ""}
${chegada.address || ""}
Link e QR Code da localiza√ß√£o:
https://maps.google.com/?q=${chegadaCoords}
`;

// Escreve o conte√∫do logo ap√≥s CHEGADA
y += 1; // pequeno espa√ßo para separar da palavra CHEGADA
doc.text(textoEntre, 10, y, { maxWidth: 180 });



// =========================
// GERAR QR CODES (CHEGADA E SA√çDA) - AJUSTADO
// =========================
const qrCanvasChegada = document.createElement("canvas");
await QRCode.toCanvas(
  qrCanvasChegada,
  `https://maps.google.com/?q=${chegadaCoords}`,
  { width: 300 }
);
const qrChegada = qrCanvasChegada.toDataURL("image/png");

const qrCanvasSaida = document.createElement("canvas");
await QRCode.toCanvas(
  qrCanvasSaida,
  `https://maps.google.com/?q=${saidaCoords}`,
  { width: 300 }
);
const qrSaida = qrCanvasSaida.toDataURL("image/png");

// Adiciona os QR Codes no PDF
doc.addImage(qrChegada, "PNG", 175, 93, 25, 25);
doc.addImage(qrSaida,   "PNG", 175, 192, 25, 25);



// =========================
// SA√çDA com bolinha azul
// =========================
y += textoEntre.split('\n').length * 6; // calcula Y para SA√çDA
doc.setFillColor(0, 0, 200); // azul
doc.circle(11, y - 2, 1.5, 'F'); // bolinha azul preenchida
doc.text(" SA√çDA", 13, y); // texto logo ap√≥s a bolinha

// =========================
// Conte√∫do depois de SA√çDA
// =========================
const textoDepoisSaida = `
Data/Hora: ${saida.timestamp}
Descri√ß√£o: ${saida.description}

${saida.coordinates || ""}
${saida.address || ""}
Link e QR Code da localiza√ß√£o:
https://maps.google.com/?q=${saidaCoords}

Tempo total de perman√™ncia:
${tempo}

Documento gerado em ${new Date().toLocaleString()}
Aplicativo dispon√≠vel no Google Play
`;

// Escreve o restante do conte√∫do
y += 1; // pequeno espa√ßo
doc.text(textoDepoisSaida, 10, y, { maxWidth: 180 });



// =========================
// MARCA D'√ÅGUA (segura) CHEGADA E SA√çDA
// =========================
doc.saveGraphicsState();
doc.setGState(doc.GState({ opacity: 0.15 })); // transpar√™ncia
doc.setFont("helvetica", "bold");
doc.setFontSize(20);

doc.setTextColor("#02779e"); // cinza claro ("#C8C8C8");

doc.text(
    "Comprovante de\nChegada e Sa√≠da",
  90, 160,
  { align: "left", angle: 45 }

);
doc.restoreGraphicsState();



// =========================
// Salvar PDF
// =========================
doc.save("Checkin+_Chegada_Saida.pdf");

closeArrivalDeparture();

}
   </script>



<!-- Bolha dentro do container -->
    <div class="bubble"></div>


    <script>
        // Script da bolha
        document.addEventListener("DOMContentLoaded", function () {
            const bubble = document.querySelector('.bubble');

            // Posi√ß√£o inicial
            let x = Math.random() * (window.innerWidth - 40); // Posi√ß√£o aleat√≥ria horizontal, ajustada para o tamanho da bolha (80px)
            let y = Math.random() * (window.innerHeight - 40); // Posi√ß√£o aleat√≥ria vertical, ajustada para o tamanho da bolha (80px)

            // Velocidade da bolha (VX e VY)
            let vx = (Math.random() - 0.5) * 2; // Velocidade horizontal (ajuste o valor 2 para controlar a velocidade)
            let vy = (Math.random() - 0.5) * 2; // Velocidade vertical (ajuste o valor 2 para controlar a velocidade)


            // Fun√ß√£o para atualizar a posi√ß√£o da bolha
            function updateBubblePosition() {
                x += vx; // Atualiza a posi√ß√£o X com a velocidade VX
                y += vy; // Atualiza a posi√ß√£o Y com a velocidade VY

                // Verifica as colis√µes com as bordas
                  // Se a bolha encostar na borda esquerda ou direita, inverte a dire√ß√£o horizontal (VX)
                if (x <= 0 || x >= window.innerWidth - 40) vx *= -1; // Ajuste o 80 para o tamanho da bolha
                  // Se a bolha encostar na borda superior ou inferior, inverte a dire√ß√£o vertical (VY)
                if (y <= 0 || y >= window.innerHeight - 40) vy *= -1; // Ajuste o 80 para o tamanho da bolha


                // Atualiza a posi√ß√£o da bolha no DOM
                bubble.style.transform = `translate(${x}px, ${y}px)`; // Aplica a nova posi√ß√£o X e Y da bolha
            }

            // Anima√ß√£o cont√≠nua
            function animate() {
                updateBubblePosition();         // Atualiza a posi√ß√£o da bolha a cada frame
                requestAnimationFrame(animate); // Chama novamente a fun√ß√£o de anima√ß√£o no pr√≥ximo frame
            }

            animate();
        });
    </script>

</body>
</html>


